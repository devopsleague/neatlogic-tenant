<?xml version="1.0" encoding="UTF-8" ?>
<!--
  ~ Copyright(c) 2022 TechSure Co., Ltd. All Rights Reserved.
  ~ 本内容仅限于深圳市赞悦科技有限公司内部传阅，禁止外泄以及用于其他的商业项目。
  -->

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="codedriver.module.tenant.dao.mapper.healthcheck.DatabaseFragmentMapper">
    <sql id="searchDatabaseFragmentCondition">
        WHERE table_schema = #{schema}
        and table_type = 'BASE TABLE'
        <if test="keyword != null and keyword != ''">
            AND table_name like concat('%',#{keyword},'%')
        </if>
    </sql>

    <select id="searchDatabaseFragment" parameterType="codedriver.framework.dto.healthcheck.DatabaseFragmentVo"
            resultType="codedriver.framework.dto.healthcheck.DatabaseFragmentVo">
        SELECT table_name AS `name`,
        `engine` AS `engine`,
        table_rows AS dataRows,
        ROUND(data_length / 1024 / 1024, 2) AS dataSize,
        ROUND(index_length / 1024 / 1024, 2) AS indexSize,
        ROUND(data_free / 1024 / 1024, 2) AS dataFree
        FROM information_schema.TABLES
        <include refid="searchDatabaseFragmentCondition"></include>
        <choose>
            <when test="sortList != null and sortList.size() > 0">
                ORDER BY
                <foreach collection="sortList" item="sort" separator=",">
                    ${sort}
                </foreach>
            </when>
            <otherwise>ORDER BY dataFree DESC</otherwise>
        </choose>
        LIMIT #{startNum},#{pageSize}
    </select>

    <select id="searchDatabaseFragmentCount" parameterType="codedriver.framework.dto.healthcheck.DatabaseFragmentVo"
            resultType="int">
        SELECT count(1)
        FROM information_schema.TABLES
        <include refid="searchDatabaseFragmentCondition"></include>
    </select>

    <update id="rebuildTable">
        alter table ${schemaName}.${tableName}
            engine =innodb
    </update>
</mapper>

